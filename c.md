# C语言笔记

## 常量

常量指的是内联的字面量，也就是立即数。
常量的存储缺乏自由，数值型的常量直接以内联的形式插入在汇编语句中，属于.text段

``` assembly
mov eax, 0x10
```

字符串常量，或者过大的数值常量则通常存储在.rodata只读数据区

``` assembly
.L1: "Hello World %d\n"
```

``` assembly
$SG6328 DB        '%lf', 0aH, 00H
        ORG $+3
$SG6329 DB        '%d', 0aH, 00H
$SG6330 DB        '%lf', 0aH, 00H

push    100                           ; 00000064H
push    OFFSET $SG6329
call    _printf
```

## 变量

函数内部static定义的变量，是全局静态变量，仅初始化一次；与应用程序同样的生命周期，只是它的作用范围只在函数内部。
函数外部声明的变量，全局变量，与应用程序同样的生命周，默认为extern的作用范围是全局，除非显式地加上static，这样作用范围是文件内部。

### 变量存储

- 全局初始化变量，存放在.data
- 全局未初始化变量，一般为0，存放在.bss
- 函数内的局部变量，存放在栈stack
- 动态申请的内存，存在堆heap

## ABI

Application Binary Interface, 规定了在某个平台上应用运行时必须遵守的一套规范。因此，它决定了应用的二进制层面的兼容性。里面包含了：

- 数据类型的定义，大小，对齐
- 函数调用的方式，入参方式，栈的维护，返回值处理等等
- 目标文件的格式
- 系统调用的方式，系统调用编号

比如，
函数的入参只有1个时，可以采用ax寄存器，多个参数的时候（小于6个），可以采用常用的寄存器组（ax，dx。。。），还有就是采用RTL顺序入栈等。
当函数只有一个返回值时，编译器可以采用rax、eax、ax寄存器传递。
当需要返回struct变量时，可能会采用栈空间传递。
返回浮点数数据，可能使用xmm寄存器。

遵从统一的ABI有助于多种不同编译器生成兼容的目标文件，这些文件可以无缝地组合成单个目标文件，或者运行时动态加载并调用对方的接口。

与ABI紧密相关的是系统平台架构和硬件体系，因为这两者的与应用的运行密切相关，ABI的设计和程序的编写必须遵循它们的约束，违反其中一条都会导致应用运行的异常。

比如，Windows的可执行文件格式为PE，Linux的是ELF；ARM与Intel的x86指令集也是不同的。

## 函数

通过函数可以将程序模块化划分，以及将任务拆解。

没有加限定的函数，默认为extern的。
内联函数，需要使用static声明，否则会遇到link error 找不到符号。在没有开启最高优化的时候，链接器会去其他目标文件中寻找符号。加了static可以保证无论优化选项，都限定在本文件内部查找符号。

函数运行主要涉及到stack的使用和维护，有的ABI规定调用者清理stack，有的约定被调用者清理stack。函数运行期间，栈指针寄存器指向的区域为栈帧，在调用其他的函数之前，rbp和rsp指向的区间就是当前函数的栈帧。

函数调用前，需要将参数入栈，之后使用call指令（保存当前指令地址，修改CS:IP）调用函数。

1. 参数入栈
2. 当前指令地址（PC寄存器地址）入栈
3. 保存bp寄存器
4. 将sp赋值给bp
5. 进入目标函数主体
6. 清理局部变量占用的空间等
7. 传递返回值，ax寄存器等
8. 将bp赋值给sp
9. pop bp
10. 使用入栈的PC寄存器地址，回到调用前的下一条指令继续执行

至此， 函数调用结束，如果期间还有调用其他函数，那么过程类似，在中途再嵌入上述所有步骤。

x86中使用enter和leave组合，enter执行3和4，leave执行8和9；
call执行2，ret执行10

## Test and profiling

- CUnit, Cmocka
- Instruments (OSX)
- Windows Performance Recorder (WPR)
- Perf (GNU/Linux)

### TAP

Test Anything Protocol
